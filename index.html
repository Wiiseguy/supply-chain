<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Game Prototype</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body class="dark">
    <div id="app" class="m-3" v-cloak>
        <h1 @dblclick="DEBUG = !DEBUG">Supply Chain Prototype</h1>
        <div class="row">
            <div class="message" v-if="message" :style="messageStyle">{{ message }}</div>
            <div class="col-6">
                <div :style="landStyle" class="land">
                    <div v-for="tile in landView" :style="tile.style" class="land-tile" :class="tile.classes"
                        :title="tile.tooltip" @click="clickTile(tile)">
                        <span class="wiggle-target grow-bounce-target">{{tile.icon}}</span>
                        <span v-if="tile.tile?.fail" class="fail fade-out">❌</span>
                        <div class="progress" :style="tile.progressStyle"></div>
                        <div class="progress progress-alt" :style="tile.progressAltStyle"></div>
                        <div class="level" v-if="tile.level != null">{{tile.level}}</div>
                    </div>
                </div>
                <h5 class="pl-1" @click="DEBUG && (money+=1, money*=10)"><strong>$</strong>&nbsp; {{ num(money) }}</h5>

                <!-- Resource stats -->
                <table>
                    <tr v-for="r in resourcesView" @click="DEBUG && r.gain(r.storageSize)">
                        <td class="text-center">{{ r.icon }}</td>
                        <td>
                            <span :class="{'text-warning': r.owned == r.storageSize}">
                                <span>{{ r.displayNamePlural }}: {{ num(r.owned) }} / {{ num(r.storageSize) }}</span>
                                <span v-if="r.lost" class="ml-3 text-danger"
                                    :title="`Lost ${r.displayNamePlural.toLowerCase()}: caused by not having enough storage`">
                                    {{ num(-r.lost) }}</span>
                            </span>
                        </td>
                    </tr>
                </table>

                <!-- Resource sell buttons -->
                <div class="mt-4">
                    <button v-for="r in resourcesView" @click="sellResource(r)" :disabled="!r.any">
                        Sell {{r.sellNum > 1 ? r.sellNum : ''}} {{ r.sellNumDisplayName }}<br>
                        <small class="text-success">+ {{ num(r.sellNumPrice) }}</small>
                    </button>
                </div>

                <!-- Automators -->
                <div class="mt-4">
                    <div v-for="a in automatorsView">
                        <button @click="toggleAutomator(a)" type="button" class="btn-sm btn-toggle-automator"
                            :title="`Every ${(1/a.speed).toFixed(1)}s`">
                            {{ a.enabled ? 'ON' : 'OFF' }}
                            <span class="progress"
                                :style="{width: (a.speed < 5 ? (a.saturation*100) : 100) + '%'}"></span>
                        </button>
                        {{ a.displayName }}: {{ boughtUpgrades[a.upgradeName] }}
                        <button @click="sellAutomator(a)" type="button" class="btn-sm p-0 px-1 btn-sell-automator">Sell
                            1</button>
                    </div>

                </div>

                <div class="mt-5">
                    <h5>Statistics</h5>
                    <div>
                        Money p/s: $ {{ num(perS.money) }}
                    </div>
                    <div class="mb-3">
                        Time played: {{ num(timeSinceStart) }}
                    </div>
                    <div>
                        Trees chopped: {{ num(treesChopped) }}
                    </div>
                    <div v-if="luckySeeds > 0">
                        Lucky seeds: {{ num(luckySeeds) }}
                    </div>
                    <div v-if="luckyTrees > 0">
                        Lucky trees: {{ num(luckyTrees) }}
                    </div>
                    <div v-if="minesOwned > 0">
                        Mines opened: {{ num(minesOwned) }}
                    </div>
                    <div v-if="resourcesMined > 0">
                        Resources mined: {{ num(resourcesMined) }}
                    </div>
                    <div v-if="tunnelsDug > 0">
                        Tunnels dug: {{ num(tunnelsDug) }}
                    </div>
                </div>
                <!-- Earnings report -->
                <div class="mt-5">
                    <a v-if="hasUpgrade('Ledger')" @click="showEarnings = !showEarnings"
                        class="btn btn-sm btn-secondary">
                        {{ showEarnings ? 'Close' : 'Open'}} ledger</a>
                    <table class="table table-sm" v-if="showEarnings">
                        <tr>
                            <th>Resource</th>
                            <th class="text-right">Owned</th>
                            <th class="text-right">Sold</th>
                            <th class="text-right">Used</th>
                            <th class="text-right">Price</th>
                            <th class="text-right">Earnings</th>
                        </tr>
                        <tr v-for="r in resourcesView">
                            <td>{{ r.displayNamePlural }}</td>
                            <td class="text-right num">{{ numf(r.totalOwned) }}</td>
                            <td class="text-right num">{{ numf(r.sold) }}</td>
                            <td class="text-right num">{{ numf(r.incurred) }}</td>
                            <td class="text-right num">{{ numf(r.price) }}</td>
                            <td class="text-right num">{{ numf(r.earnings) }}</td>
                        </tr>
                        <tr>
                            <td><strong>Total</strong></td>
                            <td class="text-right num"><strong>{{ numf(totalResourcesOwned) }}</strong></td>
                            <td class="text-right num"><strong>{{ numf(totalResourcesSold) }}</strong></td>
                            <td class="text-right num"><strong>{{ numf(totalResourcesIncurred) }}</strong></td>
                            <td class="text-right num"><strong> </strong></td>
                            <td class="text-right num"><strong>{{ numf(totalResourceEarnings) }}</strong></td>
                        </tr>
                        <tr>
                            <td colspan="5"><strong>Money spent</strong></td>
                            <td class="text-right num"><strong>{{ numf(moneySpent) }}</strong></td>
                        </tr>
                        <tr>
                            <td colspan="5"><strong>Total profit</strong></td>
                            <td class="text-right num" :class="{
                                'text-success': totalProfit > 0,
                                'text-danger': totalProfit < 0
                            }"><strong>$ {{ num(totalProfit) }}</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="col-6">
                <transition-group name="fade">
                    <div v-for="category in upgradesByCategoryView" class="mb-4" :key="category.groupTitle">
                        <h4>{{ category.groupTitle }}</h4>
                        <transition-group name="fade">
                            <button v-for="item in category.items" class="btn-upgrade" :key="item.name"
                                @click="buyUpgrade(item)" :disabled="!item.canBuy"
                                :title="item.blurred ? '?' : item.description">
                                <span class="can-blur" :class="{blur: item.blurred}">{{ item.displayName ?? item.name
                                    }}</span>
                                <sup v-if="item.max !== 1 && item.owned > 0"></sup><br>
                                <small>$ {{ num(item.cost) }}</small>
                                <span class="num" v-if="item.owned > 0">{{ num(item.owned) }}</span>
                                <span class="group-icon">{{item.blurred ? '❔' : item.groupIcon}}</span>
                            </button>
                        </transition-group>
                    </div>
                </transition-group>
            </div>
        </div>

    </div>

    <script src="game.js" type="module"></script>

</body>

</html>