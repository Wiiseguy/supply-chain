<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Game Prototype</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png" />
</head>

<body class="dark">
    <div id="app" class="m-3" v-cloak>
        <h5 @dblclick="setDebug">Supply Chain Prototype</h5>
        <div class="theme-toggle hover-opacity">
            <a @click="toggleDarkMode" class="btn-link" title="Switch between light / dark mode">
                <span v-if="settings.dark">üåô</span>
                <span v-else>‚òÄÔ∏è</span>
            </a>
        </div>
        <div class="row">
            <div class="message" v-if="message" :style="messageStyle">{{ message }}</div>
            <div class="col-6">
                <div :style="landStyle" class="land" :class="'clickmode-'+clickMode">
                    <div v-for="tile in landView" :style="tile.style" class="land-tile" :class="tile.classes"
                        :title="tile.tooltip" @click="clickTile(tile)">
                        <span class="icon wiggle-target grow-bounce-target bounce-down-target">{{tile.icon}}</span>
                        <span v-if="tile.tile?.fail" class="fail fade-out">‚ùå</span>
                        <div class="progress" :style="tile.progressStyle"></div>
                        <div class="progress progress-alt" :style="tile.progressAltStyle"></div>
                        <div class="level" v-if="tile.level != null">{{tile.level}}</div>
                        <div class="mini-icon top-left" v-if="tile.tile?.iconTopLeft">{{tile.tile?.iconTopLeft}}</div>
                        <div class="mini-icon top-right" v-if="tile.tile?.iconTopRight">{{tile.tile?.iconTopRight}}
                        </div>
                        <div class="mini-icon bottom-left" v-if="tile.tile?.iconBottomLeft">
                            {{tile.tile?.iconBottomLeft}}</div>
                        <div class="mini-icon bottom-right" v-if="tile.tile?.iconBottomRight">
                            {{tile.tile?.iconBottomRight}}</div>
                    </div>
                    <div class="mt-3 text-center toolbar" :class="{'hover-opacity': clickMode === 'click'}"
                        v-if="hasUpgrade('Bulldozer')">
                        <div class="btn-group">
                            <button @click="setClickMode('click')" :class="{'active': clickMode === 'click'}"
                                class="btn btn-xs btn-tool">Click</button>
                            <button @click="setClickMode('sell')" :class="{'active': clickMode === 'sell'}"
                                title="Sell a tile for $ 100" class="btn btn-xs btn-tool">Sell</button>
                            <button @click="setClickMode('move')" :class="{'active': clickMode === 'move'}"
                                class="btn btn-xs btn-tool">Move</button>
                        </div>
                    </div>
                </div>

                <h5 class="pl-1" @click="DEBUG && (money+=1, money*=10)">
                    <strong>$</strong>&nbsp; {{ num(money) }}
                    <div v-if="automatorsView.length > 0" class="small text-muted">
                        Money p/s: $ {{ num(perS.money) }}
                    </div>
                </h5>

                <!-- Modals -->
                <dialog :ref="MODALS.kilnBake">
                    <div v-if="modalObj">
                        <h5>Select a recipe to bake</h5>
                        <!--
                        [ { "resource": "brick", "reqs": { "clay": 10 }, "time": 10, "icon": "üß±" } ]
                        -->
                        <button class="btn-full" v-for="recipe in modalObj.recipes"
                            @click="modalObj.selectedResource = recipe.resource" class="btn-sm btn-bake-resource"
                            :class="{'btn-primary': modalObj.selectedResource === recipe.resource}">
                            {{ recipe.icon }} {{ recipe.resource }} from <span v-for="r in Object.keys(recipe.reqs)">{{
                                recipe.reqs[r] }} {{
                                r
                                }}</span> -
                            <small>{{ num(recipe.time) }}s</small>
                        </button>
                        <div class="text-right mt-4">
                            <button class="btn-sm" @click="closeModal(MODALS.kilnBake)">Cancel</button>
                            <button class="btn-sm btn-success mr-2"
                                @click="modalObj.tile.onModalSetRecipe(modalObj.selectedResource)">Bake</button>
                        </div>
                </dialog>

                <!-- Resource stats -->
                <table>
                    <tr v-for="r in resourcesView">
                        <td class="text-center">{{ r.icon }}</td>
                        <td @click="DEBUG && r.gain(r.storageSize)">
                            <span :class="{'text-warning': r.owned == r.storageSize}">
                                <span>{{ r.displayNamePlural }}: {{ num(r.owned) }} / {{ num(r.storageSize) }}</span>
                                <span v-if="r.lost" class="ml-3 text-danger"
                                    :title="`Lost ${r.displayNamePlural.toLowerCase()}: caused by not having enough storage`">
                                    {{ num(-r.lost) }}</span>
                            </span>
                        </td>
                        <td>
                            <button @click="sellResource(r, 1)" :disabled="!r.any" class="btn-xs btn-sell-resource">
                                Sell 1 <span class="text-success">+ $ {{ num(r.price) }}</span>
                            </button>
                            <button @click="sellResource(r, 10)" :disabled="!r.any" class="btn-xs btn-sell-resource"
                                v-if="sellLevel>0">
                                Sell 10 <span class="text-success">+ $ {{ num(r.sellPrice(10)) }}</span>
                            </button>
                            <button @click="sellResource(r, 100)" :disabled="!r.any" class="btn-xs btn-sell-resource"
                                v-if="r.storageSize >= 100 && sellLevel > 1">
                                Sell 100 <span class="text-success">+ $ {{ num(r.sellPrice(100)) }}</span>
                            </button>
                            <button @click="sellResource(r, r.owned)" :disabled="!r.any"
                                class="btn-xs btn-sell-resource" v-if="sellLevel > 2">
                                Sell all <span class="text-success">+ $ {{ num(r.sellPrice(r.owned)) }}</span>
                            </button>
                        </td>
                    </tr>
                </table>

                <!-- Resource sell buttons -->
                <div class="mt-4" v-if="false">
                    <button v-for="r in resourcesView" @click="sellResource(r)" :disabled="!r.any">
                        Sell {{r.sellNum > 1 ? r.sellNum : ''}} {{ r.sellNumDisplayName }} {{r.icon}}<br>
                        <small class="text-success">+ {{ num(r.sellNumPrice) }}</small>
                    </button>
                </div>

                <!-- Automators -->
                <div class="mt-4">
                    <!-- All automation toggle -->
                    <div v-if="automatorsView.length > 1">
                        <button @click="toggleAutomation" type="button" class="btn-sm btn-toggle-automator"
                            title="Click to toggle Automation">
                            {{ settings.automation ? 'ON' : 'OFF' }}
                        </button>
                        All Automation
                    </div>
                    <div v-for="a in automatorsView">
                        <button @click="toggleAutomator(a.automator)" type="button" class="btn-sm btn-toggle-automator"
                            :title="`Every ${(1/a.speed).toFixed(1)}s`">
                            {{ a.enabled && settings.automation ? 'ON' : 'OFF' }}
                            <span class="progress"
                                :style="{width: (a.speed < 5 ? (a.saturation*100) : 100) + '%'}"></span>
                        </button>
                        {{ a.icon }} {{ a.displayName }}: {{ boughtUpgrades[a.upgradeName] }}
                        <button @click="sellAutomator(a)" type="button" :title="`$ ${num(a.sellPrice)}`"
                            class="btn-xs btn-sell-automator">Sell
                            1</button>
                        <button @click="buyAutomator(a)" :disabled="!a.canBuy" :title="`$ ${num(a.buyPrice)}`"
                            type="button" class="btn-xs btn-buy-automator">Buy
                            1</button>
                    </div>
                </div>

                <div class="mt-5 selectable">
                    <h5>Statistics</h5>
                    <div class="mb-3">
                        Time played: {{ num(timeSinceStart) }}
                    </div>
                    <div>
                        Trees chopped: {{ num(stats.treesChopped) }}
                    </div>
                    <div v-if="stats.luckySeeds > 0"
                        :title="`Lucky seed chance is ${100 * calculated.luckySeedChance}%`">
                        Lucky seeds: {{ num(stats.luckySeeds) }}
                    </div>
                    <div v-if="stats.luckyTrees > 0">
                        Lucky trees: {{ num(stats.luckyTrees) }}
                    </div>
                    <div v-if="stats.minesOwned > 0" class="mt-3">
                        Mines opened: {{ num(stats.minesOwned) }}
                    </div>
                    <div v-if="stats.resourcesMined > 0">
                        Resources mined: {{ num(stats.resourcesMined) }}
                    </div>
                    <div v-if="stats.tunnelsDug > 0">
                        Tunnels dug: {{ num(stats.tunnelsDug) }}
                    </div>
                    <div v-if="stats.fishCaught > 0" class="mt-3">
                        <span :title="`Rare fish chance sequence is ${100 * calculated.rareFishLuck}%`">Fish caught: {{
                            num(stats.fishCaught) }}</span>
                        <div v-if="stats.fishTank.length > 0">
                            <span v-for="i in stats.fishTank" class="mr-3">{{i[0]}} {{i[1]}}</span>
                        </div>
                    </div>
                    <div v-if="stats.fishMissed > 0">
                        Fish missed: {{ num(stats.fishMissed) }}
                    </div>
                    <div v-if="stats.fishRarities > 0">
                        Rare pond finds: {{ num(stats.fishRarities) }}
                    </div>

                </div>
                <!-- Earnings report -->
                <div class="mt-5">
                    <a v-if="hasUpgrade('Ledger')" @click="showEarnings = !showEarnings"
                        class="btn btn-sm btn-secondary">
                        {{ showEarnings ? 'Close' : 'Open'}} ledger</a>
                    <table class="table table-sm" v-if="showEarnings">
                        <tr>
                            <th>Resource</th>
                            <th class="text-right">Owned</th>
                            <th class="text-right">Sold</th>
                            <th class="text-right">Used</th>
                            <th class="text-right">Price</th>
                            <th class="text-right">Earnings</th>
                        </tr>
                        <tr v-for="r in resourcesView">
                            <td>{{ r.displayNamePlural }}</td>
                            <td class="text-right num">{{ numf(r.totalOwned) }}</td>
                            <td class="text-right num">{{ numf(r.sold) }}</td>
                            <td class="text-right num">{{ numf(r.incurred) }}</td>
                            <td class="text-right num">{{ numf(r.price) }}</td>
                            <td class="text-right num">{{ numf(r.earnings) }}</td>
                        </tr>
                        <tr>
                            <td><strong>Total</strong></td>
                            <td class="text-right num"><strong>{{ numf(totalResourcesOwned) }}</strong></td>
                            <td class="text-right num"><strong>{{ numf(totalResourcesSold) }}</strong></td>
                            <td class="text-right num"><strong>{{ numf(totalResourcesIncurred) }}</strong></td>
                            <td class="text-right num"><strong> </strong></td>
                            <td class="text-right num"><strong>{{ numf(totalResourceEarnings) }}</strong></td>
                        </tr>
                        <tr>
                            <td colspan="5"><strong>Money spent</strong></td>
                            <td class="text-right num"><strong>{{ numf(stats.moneySpent) }}</strong></td>
                        </tr>
                        <tr>
                            <td colspan="5"><strong>Total profit</strong></td>
                            <td class="text-right num" :class="{
                                'text-success': totalProfit > 0,
                                'text-danger': totalProfit < 0
                            }"><strong>$ {{ num(totalProfit) }}</strong></td>
                        </tr>
                    </table>
                </div>
                <div class="hover-opacity" style="margin-top:200px">
                    <button @click="resetGame" class="btn btn-sm btn-danger">Reset game</button>
                </div>
            </div>
            <div class="col-6">
                <transition-group name="fade">
                    <div v-for="category in upgradesByCategoryView" class="mb-4" :key="category.groupTitle">
                        <h5>{{ category.groupTitle }}</h5>
                        <transition-group name="fade">
                            <button v-for="item in category.items" class="btn-upgrade" :key="item.name"
                                @click="buyUpgrade(item)" :disabled="!item.canBuy"
                                :title="item.blurred ? '?' : item.description">
                                <span class="can-blur font-weight-bold" :class="{blur: item.blurred}">{{
                                    item.displayName ??
                                    item.name
                                    }}</span>
                                <sup v-if="item.max !== 1 && item.owned > 0"></sup><br>
                                <small>
                                    $ {{ num(item.cost) }}
                                    <span v-for="r in item.resourcesNeeded" class="ml-1">{{ r.icon }}{{ num(r.amount)
                                        }}</span>
                                </small>
                                <span class="num" v-if="item.owned > 0">{{ num(item.owned) }}</span>
                                <span class="group-icon">{{item.blurred ? '‚ùî' : item.groupIcon}}</span>
                            </button>
                        </transition-group>
                    </div>
                </transition-group>
            </div>
        </div>

    </div>

    <script src="./src/game.js?v=3" type="module"></script>

</body>

</html>